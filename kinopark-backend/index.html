<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kinopark Online</title>
    <!-- Bootstrap & FontAwesome -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --kp-red: #e50914; --kp-black: #141414; --kp-dark: #1f1f1f; --kp-seat-selected: #e50914; }
        body { background-color: var(--kp-black); color: #fff; font-family: 'Segoe UI', sans-serif; }
        .navbar { background: rgba(0,0,0,0.95); border-bottom: 1px solid #333; }
        .brand { color: var(--kp-red); font-weight: 900; font-size: 1.5rem; text-decoration: none; cursor: pointer; }
        
        .movie-card { background: #1a1a1a; border: none; cursor: pointer; transition: 0.3s; height: 100%; border-radius: 8px; overflow: hidden; }
        .movie-card:hover { transform: scale(1.03); z-index: 10; box-shadow: 0 0 20px rgba(229,9,20,0.5); }
        .poster { height: 350px; object-fit: cover; width: 100%; }
        
        /* Seat Grid */
        .screen-display { height: 10px; background: #fff; box-shadow: 0 0 30px rgba(255,255,255,0.2); margin: 0 auto 30px; width: 60%; border-radius: 50%; opacity: 0.5; }
        .hall-container { display: grid; gap: 6px; justify-content: center; margin: 20px auto; }
        .seat { width: 30px; height: 30px; background-color: #3d3d3d; border-radius: 4px; cursor: pointer; font-size: 10px; display: flex; align-items: center; justify-content: center; color: #aaa; transition: 0.2s; }
        .seat:hover:not(.taken) { background-color: #666; transform: scale(1.1); }
        .seat.selected { background-color: var(--kp-seat-selected); color: white; box-shadow: 0 0 10px var(--kp-red); }
        .seat.taken { background-color: #1a1a1a; color: #333; cursor: not-allowed; border: 1px solid #333; pointer-events: none; }
        
        .hidden { display: none !important; }
        .btn-kp { background: var(--kp-red); color: white; border: none; font-weight: bold; }
        .btn-kp:hover { background: #b20710; color: white; }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg fixed-top">
    <div class="container">
        <a class="brand" onclick="showHome()">KINO<span>PARK</span></a>
        <div class="ms-auto">
            <div id="guest-panel">
                <button class="btn btn-sm btn-outline-light" onclick="openModal('loginModal')">Войти</button>
                <button class="btn btn-sm btn-kp ms-2" onclick="openModal('regModal')">Регистрация</button>
            </div>
            <div id="user-panel" class="hidden d-flex align-items-center gap-3">
                <span class="fw-bold text-danger" id="username-display">User</span>
                <button class="btn btn-sm btn-dark" onclick="logout()">Выйти</button>
            </div>
        </div>
    </div>
</nav>

<div class="container" style="margin-top: 80px; padding-bottom: 100px;">
    <div id="alert-box"></div>

    <!-- Список фильмов -->
    <div id="page-movies">
        <h3 class="mb-4 border-start border-4 border-danger ps-3">Афиша</h3>
        <div class="row row-cols-2 row-cols-md-4 g-4" id="movies-grid">
            <div class="text-center w-100 py-5 text-muted">Загрузка фильмов...<br><small>Если долго грузится - проверьте, запущен ли сервер.</small></div>
        </div>
    </div>

    <!-- Бронирование -->
    <div id="page-booking" class="hidden">
        <button class="btn btn-sm btn-outline-secondary mb-3" onclick="showHome()">← Назад</button>
        <div class="row">
            <div class="col-md-3">
                <img id="book-poster" src="" class="img-fluid rounded mb-3">
                <h4 id="book-title" class="fw-bold">Title</h4>
                <p class="text-secondary small" id="book-details">...</p>
                <div id="total-block" class="card bg-dark p-3 hidden border-secondary">
                    <h5 class="text-secondary">Итого:</h5>
                    <h2 class="fw-bold text-danger" id="total-price">0 ₸</h2>
                    <button class="btn btn-success w-100 mt-2 fw-bold" onclick="buyTickets()">ОПЛАТИТЬ</button>
                </div>
            </div>
            <div class="col-md-9">
                <div class="card bg-dark border-secondary p-3 mb-3">
                    <h6 class="text-muted">1. Время сеанса:</h6>
                    <div id="showtimes-container" class="d-flex flex-wrap gap-2"></div>
                </div>
                <div id="hall-block" class="card bg-dark border-secondary p-4 hidden">
                    <h6 class="text-muted text-center mb-3">2. Выбор места</h6>
                    <div class="screen-display"></div>
                    <div id="hall-grid" class="hall-container"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Вход -->
<div class="modal fade" id="loginModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark border-secondary">
            <div class="modal-body p-4 text-center">
                <h3 class="mb-4 fw-bold">Вход</h3>
                <input type="email" id="login-email" class="form-control bg-dark text-white mb-3" placeholder="Email">
                <input type="password" id="login-pass" class="form-control bg-dark text-white mb-4" placeholder="Пароль">
                <button class="btn btn-kp w-100 py-2" onclick="login()">Войти</button>
            </div>
        </div>
    </div>
</div>

<!-- Регистрация -->
<div class="modal fade" id="regModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark border-secondary">
            <div class="modal-body p-4 text-center">
                <h3 class="mb-4 fw-bold">Регистрация</h3>
                <input type="email" id="reg-email" class="form-control bg-dark text-white mb-2" placeholder="Email">
                <input type="text" id="reg-name" class="form-control bg-dark text-white mb-2" placeholder="Имя">
                <input type="password" id="reg-pass" class="form-control bg-dark text-white mb-2" placeholder="Пароль">
                <input type="password" id="reg-pass2" class="form-control bg-dark text-white mb-4" placeholder="Повтор пароля">
                <button class="btn btn-kp w-100 py-2" onclick="register()">Создать аккаунт</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const API = 'http://127.0.0.1:8000/api/v1';
    let TOKEN = localStorage.getItem('kp_token');
    let currentShowtime = null;
    let selectedSeats = [];

    document.addEventListener('DOMContentLoaded', () => {
        checkAuth();
        loadMovies();
    });

    function checkAuth() {
        if(TOKEN) {
            document.getElementById('guest-panel').classList.add('hidden');
            document.getElementById('user-panel').classList.remove('hidden');
        } else {
            document.getElementById('guest-panel').classList.remove('hidden');
            document.getElementById('user-panel').classList.add('hidden');
        }
    }

    async function login() {
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-pass').value;
        
        if(!email || !password) { alert('Введите email и пароль!'); return; }

        try {
            const res = await fetch(`${API}/auth/login/`, {
                method: 'POST', 
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({email, password})
            });
            const data = await res.json();
            
            if(res.ok) {
                TOKEN = data.tokens.access;
                localStorage.setItem('kp_token', TOKEN);
                bootstrap.Modal.getInstance(document.getElementById('loginModal')).hide();
                checkAuth();
                alertMsg('success', 'Успешный вход!');
            } else {
                alert('Ошибка входа: ' + JSON.stringify(data));
            }
        } catch(e) {
            alert('ОШИБКА СОЕДИНЕНИЯ С СЕРВЕРОМ!\nПроверьте, запущен ли python manage.py runserver');
            console.error(e);
        }
    }

    async function register() {
        const email = document.getElementById('reg-email').value;
        const full_name = document.getElementById('reg-name').value;
        const password = document.getElementById('reg-pass').value;
        const password2 = document.getElementById('reg-pass2').value;

        try {
            const res = await fetch(`${API}/auth/register/`, {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({email, full_name, password, password2})
            });
            const data = await res.json();
            if(res.ok) {
                TOKEN = data.tokens.access;
                localStorage.setItem('kp_token', TOKEN);
                bootstrap.Modal.getInstance(document.getElementById('regModal')).hide();
                checkAuth();
                alertMsg('success', 'Аккаунт создан!');
            } else {
                alert('Ошибка регистрации: ' + JSON.stringify(data));
            }
        } catch(e) { alert('Ошибка сети!'); }
    }

    function logout() {
        localStorage.removeItem('kp_token');
        TOKEN = null;
        checkAuth();
        showHome();
    }

    async function loadMovies() {
        try {
            const res = await fetch(`${API}/movies/`);
            const data = await res.json();
            const movies = data.results || data;
            const grid = document.getElementById('movies-grid');
            grid.innerHTML = '';
            
            movies.forEach(m => {
                grid.innerHTML += `
                    <div class="col">
                        <div class="movie-card" onclick="openBooking(${m.id})">
                            <img src="${m.poster || 'https://via.placeholder.com/300'}" class="poster">
                            <div class="p-3">
                                <h5 class="text-truncate fw-bold">${m.title}</h5>
                                <small class="text-secondary">${m.duration} мин | ⭐ ${m.rating}</small>
                            </div>
                        </div>
                    </div>`;
            });
            window.moviesCache = movies;
        } catch(e) {
            document.getElementById('movies-grid').innerHTML = '<div class="text-danger w-100 text-center">Не удалось загрузить фильмы. Сервер недоступен.</div>';
        }
    }

    async function openBooking(movieId) {
        if (!TOKEN) {
            // Если не вошел - показываем модалку и прерываем
            new bootstrap.Modal(document.getElementById('loginModal')).show();
            return;
        }
        
        const movie = window.moviesCache.find(m => m.id === movieId);
        document.getElementById('page-movies').classList.add('hidden');
        document.getElementById('page-booking').classList.remove('hidden');
        document.getElementById('book-title').innerText = movie.title;
        document.getElementById('book-details').innerText = `${movie.duration} мин | ${movie.language}`;
        document.getElementById('book-poster').src = movie.poster;
        
        document.getElementById('hall-block').classList.add('hidden');
        document.getElementById('total-block').classList.add('hidden');

        // Load Showtimes
        const container = document.getElementById('showtimes-container');
        container.innerHTML = 'Загрузка...';
        
        // ВАЖНО: Добавляем Bearer токен
        const res = await fetch(`${API}/showtimes/?movie=${movieId}`, {
            headers: {'Authorization': `Bearer ${TOKEN}`}
        });
        
        if (res.status === 401) {
            alert('Ваша сессия истекла. Пожалуйста, войдите снова.');
            logout();
            return;
        }

        const data = await res.json();
        const showtimes = data.results || data;
        container.innerHTML = '';
        
        if(!showtimes.length) container.innerHTML = '<span class="text-muted">Нет сеансов</span>';

        showtimes.forEach(st => {
            const time = new Date(st.start_time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            const btn = document.createElement('button');
            btn.className = 'btn btn-outline-light btn-sm';
            btn.innerHTML = `${time}<br><small>${st.price} ₸</small>`;
            btn.onclick = () => loadHall(st, btn);
            container.appendChild(btn);
        });
    }

    async function loadHall(showtime, btn) {
        currentShowtime = showtime;
        selectedSeats = [];
        updateTotal();

        document.querySelectorAll('#showtimes-container button').forEach(b => {
            b.classList.remove('btn-danger'); b.classList.add('btn-outline-light');
        });
        btn.classList.remove('btn-outline-light'); btn.classList.add('btn-danger');

        document.getElementById('hall-block').classList.remove('hidden');
        const grid = document.getElementById('hall-grid');
        grid.innerHTML = 'Загрузка...';

        const hallId = showtime.hall.id || showtime.hall;

        try {
            const [resSeats, resBookings] = await Promise.all([
                fetch(`${API}/seats/?hall=${hallId}`, {headers: {'Authorization': `Bearer ${TOKEN}`}}),
                fetch(`${API}/bookings/?showtime=${showtime.id}`, {headers: {'Authorization': `Bearer ${TOKEN}`}})
            ]);

            const seatsData = await resSeats.json();
            const bookingsData = await resBookings.json();
            const allSeats = seatsData.results || seatsData;
            const takenIds = (bookingsData.results || bookingsData).map(b => b.seat.id || b.seat);

            grid.innerHTML = '';
            grid.style.gridTemplateColumns = `repeat(10, 1fr)`;

            allSeats.sort((a,b) => (a.row - b.row) || (a.number - b.number));

            allSeats.forEach(s => {
                const el = document.createElement('div');
                el.className = 'seat';
                el.innerText = s.number;
                el.title = `Ряд ${s.row}, Место ${s.number}`;

                if(takenIds.includes(s.id)) {
                    el.classList.add('taken');
                } else {
                    el.onclick = () => toggleSeat(s, el);
                }
                grid.appendChild(el);
            });
        } catch(e) {
            console.error(e);
            grid.innerHTML = 'Ошибка загрузки мест (проверьте консоль)';
        }
    }

    function toggleSeat(seat, el) {
        if(el.classList.contains('selected')) {
            el.classList.remove('selected');
            selectedSeats = selectedSeats.filter(s => s.id !== seat.id);
        } else {
            el.classList.add('selected');
            selectedSeats.push(seat);
        }
        updateTotal();
    }

    function updateTotal() {
        const totalBlock = document.getElementById('total-block');
        if(selectedSeats.length > 0) {
            totalBlock.classList.remove('hidden');
            const total = selectedSeats.length * parseFloat(currentShowtime.price);
            document.getElementById('total-price').innerText = `${total} ₸`;
        } else {
            totalBlock.classList.add('hidden');
        }
    }

    async function buyTickets() {
        if(!selectedSeats.length) return;
        const seatIds = selectedSeats.map(s => s.id);
        
        try {
            const res = await fetch(`${API}/bookings/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${TOKEN}`
                },
                body: JSON.stringify({
                    showtime: currentShowtime.id,
                    seats: seatIds
                })
            });

            if(res.ok) {
                alert('✅ Оплата прошла успешно! Билеты куплены.');
                window.location.reload(); 
            } else {
                const err = await res.json();
                alert('Ошибка: ' + JSON.stringify(err));
            }
        } catch(e) { console.error(e); }
    }

    function showHome() {
        document.getElementById('page-movies').classList.remove('hidden');
        document.getElementById('page-booking').classList.add('hidden');
    }
    function openModal(id) { new bootstrap.Modal(document.getElementById(id)).show(); }
    function alertMsg(type, msg) {
        const box = document.getElementById('alert-box');
        box.innerHTML = `<div class="alert alert-${type}">${msg}</div>`;
        setTimeout(() => box.innerHTML='', 3000);
    }
</script>
</body>
</html>